{% extends "users/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <div id='content' style="display:none"> </div>
	<div id="noonejoined" class="h2" style="color: #999;">
		Waiting for others to join..
	</div>
    <div class="container-fluid">
		<div class="row">
			<div id="copy" style="display: none;" class="col-md-6 offset-md-3 mt-1">
				<div class="alert alert-info alert-dismissible fade show" role="alert">
					Room Link Copied to Clipboard!
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			</div>
			<div id="noroom" class="col-md-6 offset-md-3 mt-1">
				
			</div>
			<div id="my_room" style="display: none;"></div>
			
			<center><div id="call_ended" class="h1 mt-4" style='display:none;'>Call Ended</div></center>
		</div>
		
		<div class="row">
			<div class="container">
				<div id="canvas" class="row row-cols-lg-4 row-cols-md-3 row-cols-2"></div>
				<div class="myvideo_container">
					<video id='myvideo' width="320" height="240" autoplay muted></video>
					<div id="mymuted">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-mic-mute" viewBox="0 0 16 16">
							<path d="M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879l-1-1V3a2 2 0 0 0-3.997-.118l-.845-.845A3.001 3.001 0 0 1 11 3z"/>
							<path d="m9.486 10.607-.748-.748A2 2 0 0 1 6 8v-.878l-1-1V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"/>
						</svg>
					</div>
				</div>
			</div>
			
		</div>
	</div>
	
	<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
		<div class="offcanvas-header border-bottom">
			<!-- <h5 id="offcanvasRightLabel">Chat</h5>
			<h5 id="offcanvasLeftLabel">Chat</h5> -->
			<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body" id="offcanvas-body">
			<div class="d-flex flex-row" style="justify-content: space-between !important;margin: 0 !important;">
				<h5 class="sidebarheadings flex-fill d-flex align-items-center justify-content-center p-2 rounded" onclick='show_chat()'><i id="chat_icon" class="bi bi-chat-square-text-fill"></i></h5>
				<h5 class="sidebarheadings flex-fill d-flex align-items-center justify-content-center p-2 rounded" onclick='show_people()'><i id="people_icon" class="bi bi-people"></i></h5>
			</div>
			<div id="allmsgs">
				<div id="msgs" class="mb-5"></div>
				<div class="chatinput">
					<input type="text" id="input_msg" placeholder="Message" class="col-10">
					<div id="send"  onclick="send_msg()">
						<i class="fa fa-paper-plane"></i>
					</div>
				</div>
			</div>
			<div id="userlist" style="display:none"></div>
		</div>
	</div>
	<div class="row main">
		<div id="users_btn" class="col-md-5 offset-md-1 col-12 mt-5 pt-4 pb-3" style="position: relative; height: fit-content; background: rgba(255,255,255,0.9);">
			<label for="users_btn" class="h3 text-muted p-1" style="position: absolute; top: 0;left: 0; transform: translate(29%,2%);background: rgba(255,255,255,1);">Room</label>
			<div class="py-5 d-flex flex-md-row flex-column  align-items-center border border-dark rounded roomborder" style="justify-content: space-evenly !important;">
				<div class="btn btn-outline-primary m-1 p-2" onclick="create_room()" >Create Room</div>
				<input type="text" id='join_room' class="rounded border p-1" placeholder="Enter Room Code" autocomplete="off" />
				<div class="font-weight-bold btn-sm btn-outline-primary m-1 px-3" id="join" onclick="join_room()" >Join</div>
			</div>
			
		</div>
		<div class=" col-md-2 offset-md-2 col-12 mt-5 d-flex align-items-center justify-content-center flex-column" id="selfvideocontainer" style="display: none !important;">
			<video autoplay="true" id="selfvideo"></video>
			<div class="d-flex align-items-center mt-1 flex-fill" id="selfvideobtns" style="justify-content: space-evenly;width: 100% !important;">
				<div class="btn btn-outline-success " id="toggle_audio_home" onclick="toggle_audio_home()">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
						<path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
						<path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
					  </svg>
				</div>
				<div class="btn btn-outline-success" id="toggle_video_home" onclick="toggle_video_home()">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-video" viewBox="0 0 16 16">
						<path fill-rule="evenodd" d="M0 5a2 2 0 0 1 2-2h7.5a2 2 0 0 1 1.983 1.738l3.11-1.382A1 1 0 0 1 16 4.269v7.462a1 1 0 0 1-1.406.913l-3.111-1.382A2 2 0 0 1 9.5 13H2a2 2 0 0 1-2-2V5zm11.5 5.175 3.5 1.556V4.269l-3.5 1.556v4.35zM2 4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h7.5a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H2z"/>
					  </svg>
				</div>
			</div>
		</div>
	</div>
		
	<footer class="floating_btns" id="toggle_btns">
		<div class="btn btn-outline-success " id="toggle_audio" onclick="toggle_audio()">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
				<path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
				<path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
			  </svg>
		</div>
		<div class="btn btn-outline-success" id="toggle_video" onclick="toggle_video()">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-video" viewBox="0 0 16 16">
				<path fill-rule="evenodd" d="M0 5a2 2 0 0 1 2-2h7.5a2 2 0 0 1 1.983 1.738l3.11-1.382A1 1 0 0 1 16 4.269v7.462a1 1 0 0 1-1.406.913l-3.111-1.382A2 2 0 0 1 9.5 13H2a2 2 0 0 1-2-2V5zm11.5 5.175 3.5 1.556V4.269l-3.5 1.556v4.35zM2 4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h7.5a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H2z"/>
			  </svg>
		</div>
		<div class="btn btn-outline-danger" onclick="leave();">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone-x" viewBox="0 0 16 16">
				<path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
				<path fill-rule="evenodd" d="M11.146 1.646a.5.5 0 0 1 .708 0L13 2.793l1.146-1.147a.5.5 0 0 1 .708.708L13.707 3.5l1.147 1.146a.5.5 0 0 1-.708.708L13 4.207l-1.146 1.147a.5.5 0 0 1-.708-.708L12.293 3.5l-1.147-1.146a.5.5 0 0 1 0-.708z"/>
			  </svg>
		</div>
		<div class="btn btn-outline-success" id="screen" onclick="toggle_share()">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cast" viewBox="0 0 16 16">
				<path d="m7.646 9.354-3.792 3.792a.5.5 0 0 0 .353.854h7.586a.5.5 0 0 0 .354-.854L8.354 9.354a.5.5 0 0 0-.708 0z"/>
				<path d="M11.414 11H14.5a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5h-13a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h3.086l-1 1H1.5A1.5 1.5 0 0 1 0 10.5v-7A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v7a1.5 1.5 0 0 1-1.5 1.5h-2.086l-1-1z"/>
			  </svg>
		</div>
		<button class="btn btn-outline-info" type="button" id="chatbox" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-text" viewBox="0 0 16 16">
				<path d="M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1H2zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12z"/>
				<path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
			  </svg>
		</button>
	</footer>
	<div id="new_room" style="display: none;"></div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>

	<!-- TODO: Add SDKs for Firebase products that you want to use
		https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
    <!--end-->
	<script>
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		var firebaseConfig = {
			apiKey: "AIzaSyDcEdb_lBOs9m-XEP9W7zv9PIorCupBu5s",
			authDomain: "simple-91dd0.firebaseapp.com",
			projectId: "simple-91dd0",
			storageBucket: "simple-91dd0.appspot.com",
			messagingSenderId: "260826023789",
			appId: "1:260826023789:web:7c82f5c42aac10a059fc64",
			measurementId: "G-WCWNLD08KZ"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
	</script>

    <script type="text/javascript" defer>
		var peer = new Peer();
		var myid;
		var room_member_list=[];
		var mystream =[];
		peer.on('open', function(id) {
			myid = id;
			firebase.database().ref('users/{{ curr_user }}/peer_id').set({
			peer_id:myid,
			})
		});
		function hide_btns(){
			document.getElementById('users_btn').style.display = 'none';
		}
		function show_leave_btn(){
			document.getElementById('toggle_btns').style.display = 'flex';
			document.getElementById('chatbox').style.display = 'grid'
		}
		function create_room(){
			hide_btns();
			document.getElementById('selfvideocontainer').remove()
			dbRef = firebase.database().ref('room/')
			var key = dbRef.push().getKey();
			var new_room_number = key;
			//console.log(new_room_number)
			firebase.database().ref(`users/{{ curr_user }}/room/`).set({room:new_room_number,})
			//firebase.database().ref('room_number/').update({room_number:new_room_number,});
			firebase.database().ref(`/room/${new_room_number}/{{ curr_user }}/`).set({
				video:true,
				audio:true,
			})
			/*firebase.database().ref(`roomadmin/${new_room_number}/{{ curr_user }}`).set({
				admin:true,
			})*/
			document.getElementById('noonejoined').style.display = 'flex'
			document.getElementById('my_room').innerText = new_room_number;
			const el = document.createElement('textarea');
			var currentUrl = window.location.href;
			el.value = currentUrl+'room/'+new_room_number;
			document.body.appendChild(el);
			el.select();
			document.execCommand('copy');
			document.getElementById('copy').style.display = 'block'
			document.body.removeChild(el);
			firebase.database().ref(`wantstojoin/${new_room_number}/`).on('child_added',(child)=>{
				var accept = confirm(`${child.key} wants to join`);
				if(accept){
					firebase.database().ref(`room/${new_room_number}/${child.key}`).set({
						video:true,
						audio:true,
					})
					firebase.database().ref(`users/${child.key}/room/`).set({room:new_room_number,})
					firebase.database().ref(`wantstojoin/${new_room_number}/${child.key}`).remove()
				}else{
					firebase.database().ref(`wantstojoin/${new_room_number}/${child.key}`).remove()
				}
			})
			window.history.replaceState('room', 'Title', `/room/${new_room_number}`);
		}
		
		function join_room(){
			var join_room_id = document.getElementById('join_room').value;
			if(join_room_id.includes('room')){
				let url = join_room_id.split('/')
				join_room_id = url[url.length - 1]
			}
			firebase.database().ref(`room/${join_room_id}/`).once('value',(child)=>{
				if(!child.exists()){
					document.getElementById('noroom').style.display = 'block'
					document.getElementById('noroom').innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
						Room Does Not Exists!!
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>`
					document.getElementById('join_room').value = '';
					return
				}else{
					hide_btns();
					document.getElementById('selfvideocontainer').remove()
				}
			})
			document.getElementById('my_room').innerText = join_room_id;
			//firebase.database().ref(`users/{{ curr_user }}/room/`).set({room:join_room_id,})
			//firebase.database().ref('room_number/').update({room_number:join_room_id,});
			firebase.database().ref(`/wantstojoin/${join_room_id}/{{ curr_user }}/`).set({
				video:true,
				audio:true,
			})
			firebase.database().ref(`room/${join_room_id}/`).on('child_added',(child)=>{
				if(child.key=='{{ curr_user }}'){
					firebase.database().ref(`/room/${join_room_id}/`).once('value',(childsnapshot)=>{
						childsnapshot.forEach((element)=>{
							if(element.key!='{{ curr_user }}'){
								firebase.database().ref(`users/${element.key}/peer_id`).once('value',(getting_members_id)=>{
									connect(getting_members_id.val().peer_id,element.key);
								})
							}
						})
					})
					firebase.database().ref(`/room/${join_room_id}/`).on('child_changed',(member_stream_properties)=>{
						if(member_stream_properties.key != '{{ curr_user }}'){
							if(member_stream_properties.val().audio==false ){
								document.getElementById(`${member_stream_properties.key}muted`).style.display = 'flex';
							}else if(member_stream_properties.val().audio==true ){
								document.getElementById(`${member_stream_properties.key}muted`).style.display = 'none';
							}
						}
					})
				}
				
			})
			
		}
		sendvideocall = (anotherpeersid,uname)=>{
			getUserMedia({video: true, audio: true}, function(stream) {
				mystream.push(stream);
				var call = peer.call(anotherpeersid, stream, { metadata: { userName: '{{ curr_user }}' } });
				call.once('stream', function(remoteStream) {
					if(!room_member_list.includes(remoteStream.id)){
						room_member_list.push(remoteStream.id)
						var canvas = document.getElementById('canvas');
						var div = document.createElement('div');
						var videodiv = document.createElement('div')
						videodiv.setAttribute('class','idiv')
						div.setAttribute('id',`${uname}div`)
						div.setAttribute('class','col rounded')
						var video_element = document.createElement('video');
						video_element.setAttribute('id',uname)
						video_element.autoplay = true;
						video_element.srcObject = remoteStream;
						videodiv.append(video_element);
						var i = document.createElement('i');
						i.setAttribute('class','bi bi-pin pin')
						i.setAttribute('onclick',`pin('${uname}')`)
						videodiv.append(i);
						var muted_icon_div = document.createElement('div')
						muted_icon_div.setAttribute('class','muted')
						muted_icon_div.setAttribute('id',`${uname}muted`)
						var mute_icon = document.createElement('i');
						mute_icon.setAttribute('class','bi bi-mic-mute')
						var display_uname = document.createElement('div')
						display_uname.setAttribute('class','display_uname px-1')
						display_uname.innerText = uname
						muted_icon_div.append(mute_icon)
						videodiv.append(muted_icon_div);
						videodiv.append(display_uname);
						div.append(videodiv)
						if(pinned){	
							div.setAttribute('style','display:none;');
						}
						document.getElementById('noonejoined').style.display = 'none'
						canvas.append(div);
						document.getElementById('myvideo').srcObject = stream;
						show_leave_btn();
						//document.getElementById('toggle_btns').style.display = 'flex';
						firebase.database().ref(`users/${uname}/room`).get().then((childsnapshot)=>{
							firebase.database().ref(`room/${childsnapshot.val().room}/${uname}`).get().then((child)=>{
								if(!child.val().audio){
									document.getElementById(`${uname}muted`).style.display = 'flex';
								}
							})
						})
						if(!audio_on){
							toggle_mute()
						}
						if(!video_on){
							toggle_videooff()
						}
					}
				})
			}, function(err) {
			console.log('Failed to get local stream' ,err);
			});
		}


		function connect(anotherpeersid,uname){
			var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
			var conn = peer.connect(anotherpeersid);
			// on open will be launch when you successfully connect to PeerServer
			sendvideocall(anotherpeersid,uname);
		}
		
		var data_received;
		
		var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		//todo Later: 
		peer.on('call', function(call) {
			hide_btns();
			getUserMedia({audio:true,video:true}, function(stream) {
				mystream.push(stream);
				data_received = call.metadata.userName;
				call.answer(stream); // Answer the call with an A/V stream.
				call.once('stream', function(remoteStream) {
					if(!room_member_list.includes(remoteStream.id)){
						room_member_list.push(remoteStream.id)
						//console.log(remoteStream.id,'receive vala')
						var div = document.createElement('div');
						var canvas = document.getElementById('canvas');
						var videodiv = document.createElement('div')
						videodiv.setAttribute('class','idiv')
						div.setAttribute('id',`${data_received}div`)
						div.setAttribute('class','col rounded')
						if(data_received=='{{ curr_user }}_Screen'){
							div.setAttribute('class','border border-dark d-flex justify-content-center align-items-center flex-column rounded m-1 py-2')
							var presenting = document.createElement('div');
							presenting.setAttribute('id',`${data_received}`)
							presenting.setAttribute('class','col presenting rounded m-1 flex-fill text-center my-5')
							presenting.innerText = 'You Are Presenting'
							div.append(presenting)
							let stop_share = document.createElement('div')
							stop_share.setAttribute('class','btn btn-sm btn-outline-danger mt-1')
							stop_share.innerText = 'Stop Presenting'
							stop_share.setAttribute('onclick','stop_share()');
							div.append(stop_share)
							videodiv.setAttribute('style','display:none;');
						}else{
							var video_element = document.createElement('video');
							video_element.setAttribute('id',data_received);
							video_element.autoplay = true;
							video_element.srcObject = remoteStream;
							if(data_received.includes('_Screen')){
								video_element.setAttribute('style','transform: rotateY(0deg);')
							}
							videodiv.append(video_element);
							var i = document.createElement('i');
							i.setAttribute('class','bi bi-pin pin')
							i.setAttribute('onclick',`pin('${data_received}')`)
							videodiv.append(i);
							if(data_received.includes('_Screen')){
								var i1 = document.createElement('i');
								i1.setAttribute('class','bi bi-fullscreen fullscreen')
								i1.setAttribute('onclick',`toggleFullscreen('${data_received}')`)
								videodiv.append(i1);
							}
							
						}
						var muted_icon_div = document.createElement('div')
						muted_icon_div.setAttribute('class','muted')
						muted_icon_div.setAttribute('id',`${data_received}muted`)
						var mute_icon = document.createElement('i');
						mute_icon.setAttribute('class','bi bi-mic-mute')
						var display_uname = document.createElement('div')
						display_uname.setAttribute('class','display_uname px-1')
						display_uname.innerText = data_received
						muted_icon_div.append(mute_icon)

						videodiv.append(muted_icon_div);
						videodiv.append(display_uname)
						div.append(videodiv)
						if(pinned){	
							div.setAttribute('style','display:none;');
						}
						document.getElementById('noonejoined').style.display = 'none'
						canvas.append(div);
						document.getElementById('myvideo').srcObject = stream;
						show_leave_btn()
						//document.getElementById('toggle_btns').style.display = 'flex';
						firebase.database().ref('users/{{curr_user}}/room').get().then((child)=>{
							firebase.database().ref(`/room/${child.val().room}/`).on('child_changed',(member_stream_properties)=>{
								if(member_stream_properties.key != '{{ curr_user }}' || !member_stream_properties.key.includes('_Screen')){
									if(member_stream_properties.val().audio==false ){
										document.getElementById(`${member_stream_properties.key}muted`).style.display = 'flex';
									}else if(member_stream_properties.val().audio==true ){
										document.getElementById(`${member_stream_properties.key}muted`).style.display = 'none';
									}
								}

							})
						})
						firebase.database().ref(`users/${data_received}/room`).get().then((childsnapshot)=>{
							firebase.database().ref(`room/${childsnapshot.val().room}/${data_received}`).get().then((child)=>{
								if(!child.val().audio){
									document.getElementById(`${data_received}muted`).style.display = 'flex';
								}
							})
						})

						if(!audio_on){
							toggle_mute()
						}
						if(!video_on){
							toggle_videooff()
						}
						
						/*check_audio()
						check_video()*/
						/*if(toggle){
							stream.getAudioTracks()[0].enabled = !(stream.getAudioTracks()[0].enabled);
						}*/
					}
					})
					
				//}
			}, function(err) {
				console.log('Failed to get local stream' ,err);
			});
		});
		
		/*$(document).on('submit','#peer_id_updateform',function(e){
			e.preventDefault();
			var token = "{{csrf_token}}";
			$.ajax({
			type: "POST",
			headers: { "X-CSRFToken": token },
			url: "{% url 'home' %}",
			data: {'peer_id':document.getElementById('id_peer_id').value},

			success: function (data) {
				console.log(data);
			},
			error: function (data) {},
			});
		})*/
		window.onbeforeunload = function(e) {
			firebase.database().ref('users/{{ curr_user }}/room').get().then((bachu)=>{
				firebase.database().ref(`room/${bachu.val().room}/{{ curr_user }}`).remove()
				firebase.database().ref(`room/${bachu.val().room}/{{ curr_user }}_Screen`).remove()
				firebase.database().ref('users/{{ curr_user }}_Screen/').remove()
				firebase.database().ref('users/{{ curr_user }}/room').remove()
				firebase.database().ref(`wantstojoin/${bachu.val().room}/{{ curr_user }}`).remove()

			});
		}
		
		leave=()=>{
			window.location.href = '{% url "home" %}'
		}
		var all_users = document.getElementById('userlist')
		
		firebase.database().ref('users/{{ curr_user }}/room').on('value',(snapshot)=>{
			if(snapshot.val()!=null){
				firebase.database().ref(`room/${snapshot.val().room}/`).on('child_removed', (data) => {
					document.getElementById(`${data.key}div`).remove()
					if(document.getElementById('canvas').innerHTML==''){
						firebase.database().ref(`room/${snapshot.val().room}/{{ curr_user }}`).remove().then((childu)=>{
							document.getElementById('mymuted').style.display = 'none'
							document.getElementById('toggle_btns').style.display='none'
							document.getElementById('call_ended').style.display = 'block';	
							document.getElementById('myvideo').remove();
							firebase.database().ref(`chat/${snapshot.val().room}`).remove().then((smolchild)=>{})
							document.getElementById('chatbox').style.display= 'none'
							setTimeout(()=>{
								window.location.reload()
							},2000)
						})
					}
				}) 
				firebase.database().ref(`room/${snapshot.val().room}/`).on('child_added',(child)=>{
					var div = document.createElement('div')
					var pin_icon = document.createElement('i')
					pin_icon.setAttribute('class','bi bi-pin thumbtack')
					pin_icon.setAttribute('onclick',`pin('${child.key}')`)
					div.setAttribute('class','message border-top my-1 peoplelist');
					div.setAttribute('id',`${child.key}_people`);
					div.innerText = child.key
					if(child.key != '{{curr_user}}'){
						div.append(pin_icon)
					}
					all_users.append(div)
				})
				firebase.database().ref(`room/${snapshot.val().room}/`).on('child_removed',(child)=>{
					document.getElementById(`${child.key}_people`).remove()
				})
			}	
		})
		
		var audio_on = true
		var video_on = true
		function toggle_audio(){
			if(audio_on){
				toggle_mute();
			}else{
				toggle_unmute();	
			}
		}
		function toggle_video(){
			if(video_on){
				toggle_videooff();
			}else{
				toggle_videoon();
			}
		}
		function toggle_mute(){
			audio_on = false
			for(stream2 of mystream){
				if(stream2.getAudioTracks()[0].enabled){
					stream2.getAudioTracks()[0].enabled = !(stream2.getAudioTracks()[0].enabled);
				}
			if(!stream2.getAudioTracks()[0].enabled){
				document.getElementById('toggle_audio').setAttribute('class','btn btn-danger btn');
				document.getElementById('mymuted').style.display = 'flex';
				firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
					firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({audio:false})
				});
			}else{
				document.getElementById('toggle_audio').setAttribute('class','btn btn-outline-success btn');
				document.getElementById('mymuted').style.display = 'none';
				firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
					firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({audio:true})
				});
			}
			}
		}
		function toggle_unmute(){
			audio_on = true
			for(stream2 of mystream){
				if(!stream2.getAudioTracks()[0].enabled){
					stream2.getAudioTracks()[0].enabled = !(stream2.getAudioTracks()[0].enabled);
				}
			if(!stream2.getAudioTracks()[0].enabled){
				document.getElementById('toggle_audio').setAttribute('class','btn btn-danger btn');
				document.getElementById('mymuted').style.display = 'flex';
				firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
					firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({audio:false})
				});
			}else{
				document.getElementById('toggle_audio').setAttribute('class','btn btn-outline-success btn');
				document.getElementById('mymuted').style.display = 'none';
				firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
					firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({audio:true})
				});
			}
			}
		}
		
		function toggle_videoon(){
			video_on = true
			for(stream1 of mystream){
				if(!stream1.getVideoTracks()[0].enabled){
					stream1.getVideoTracks()[0].enabled = !(stream1.getVideoTracks()[0].enabled);
				}
				if(!stream1.getVideoTracks()[0].enabled){
					document.getElementById('toggle_video').setAttribute('class','btn btn-danger btn');
					firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
						firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({video:false})
					});
				}else{
					document.getElementById('toggle_video').setAttribute('class','btn btn-outline-success btn');
					firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
						firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({video:true})
					});
				}
			}
			}
			function toggle_videooff(){
				video_on = false
			for(stream1 of mystream){
				if(stream1.getVideoTracks()[0].enabled){
					stream1.getVideoTracks()[0].enabled = !(stream1.getVideoTracks()[0].enabled);
				}
				
				if(!stream1.getVideoTracks()[0].enabled){
					document.getElementById('toggle_video').setAttribute('class','btn btn-danger btn');
					firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
						firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({video:false})
					});
				}else{
					document.getElementById('toggle_video').setAttribute('class','btn btn-outline-success btn');
					firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
						firebase.database().ref(`room/${child.val().room}/{{ curr_user }}`).update({video:true})
					});
				}
			}
			}
			var myScreen
			function Screen_Share(){
				var SShareID = new Peer();
				SShareID.on('open', function(id) {
					var myscreenid = id;
					firebase.database().ref(`users/{{ curr_user }}_Screen/peer_id`).set({
						peer_id:myscreenid,
					})
					
				});
						
				firebase.database().ref('users/{{ curr_user }}/room').get().then((child)=>{
					firebase.database().ref(`/room/${child.val().room}/{{ curr_user }}_Screen/`).set({
						video:true,
						audio:true,
					})
					firebase.database().ref(`users/{{ curr_user }}_Screen/room/`).set({room:child.val().room,})
				});
				
				myScreen = navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
				firebase.database().ref('users/{{ curr_user }}/room').get().then((snapshot)=>{
					firebase.database().ref(`room/${snapshot.val().room}/`).on("value",(childsnapshot)=>{
						childsnapshot.forEach((element)=>{
							console.log('val',element.val(),'key',element.key)
							if(element.key!='{{ curr_user }}_Screen'){
								firebase.database().ref(`users/${element.key}/peer_id`).get().then((getting_members_id)=>{
									myScreen.then(function(stream){
										//document.getElementById('myscreenshare').srcObject = stream
										document.getElementById('screen').setAttribute('class','btn btn-danger btn');
										var call = peer.call(getting_members_id.val().peer_id, stream,{ metadata: { userName: '{{ curr_user }}_Screen' } });
										stream.getVideoTracks()[0].onended = function () {
											firebase.database().ref(`room/${snapshot.val().room}/{{ curr_user }}_Screen`).remove().then((child)=>{})
											firebase.database().ref('users/{{ curr_user }}_Screen').remove().then((childsnap)=>{})
											document.getElementById('screen').setAttribute('class','btn btn-outline-success btn');
											t_share = false
										};
									})
								})
							}
						})
					})
				})
				t_share = true
			}
			
			stop_share = ()=>{
				myScreen.then(function(stream){
					const tracks = stream.getTracks();
					tracks.forEach(function(track) {
						track.stop();
					});
					firebase.database().ref('users/{{ curr_user }}/room').get().then((snapshot)=>{				
						firebase.database().ref(`room/${snapshot.val().room}/{{ curr_user }}_Screen`).remove().then((child)=>{})
						firebase.database().ref('users/{{ curr_user }}_Screen').remove().then((childsnap)=>{})
					})
					document.getElementById('screen').setAttribute('class','btn btn-outline-success btn');
					})		
				t_share = false
			}
			var t_share = false
			toggle_share=()=>{
				if(!t_share){
					Screen_Share()				
				}else{
					stop_share()		
				}
			}

	  send_msg = ()=>{
		if(document.getElementById('input_msg').value == ''){
			return
		}
		message = document.getElementById('input_msg').value;
		document.getElementById('input_msg').value = '';
		firebase.database().ref('users/{{curr_user}}/room').get().then((child)=>{
			firebase.database().ref(`chat/${child.val().room}`).push({
				['{{curr_user}}']:message,
			})
		})
	  }
	  firebase.database().ref('users/{{curr_user}}/room').on('child_added',(child)=>{
		  //isko connect k andr lgana h
			firebase.database().ref(`chat/${child.val()}`).on('child_added',(childsnapshot)=>{
				chat = document.getElementById('msgs');
				msg = document.createElement('div')
				msg.setAttribute('class','message border-top my-1');
				span = document.createElement('span');
				//span.setAttribute('class','muted')
				var uname=[]
				for (var k in childsnapshot.val()) uname.push(k);
				uname = uname[0]
				current = new Date()
				date = current.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
				span.innerHTML=`<span> ${uname}</span><span>${date}</span>`;
				msg.innerText= childsnapshot.val()[uname];
				msg.append(span);
				chat.appendChild(msg);
				let vScrollBar = document.getElementById('offcanvas-body');
            	vScrollBar.scrollTop = vScrollBar.scrollHeight;
			})
		})
		document.getElementById('users_btn').style.display='none'
		
		check_url = ()=>{
			var currentUrl = window.location.href;
			var url_parts = currentUrl.split('/')
			if(url_parts.includes('room')){
				firebase.database().ref(`room/${url_parts[url_parts.length-1]}`).get().then((child)=>{
					if(child.val()!=null){
						document.getElementById('join_room').value = url_parts[url_parts.length-1]
						join_room()
					}else{
						window.location = '{% url "home" %}'
					}
				
				})	
				
			}else{
				document.getElementById('users_btn').style.display='block'
				document.getElementById('selfvideocontainer').style.display='block'
			}
			
		}
		setTimeout(function(){
			check_url()
		},500)

		$(document).on('keypress',function(e) {
			if(document.getElementById('chatbox').style.display == 'grid' || true) {
				if(e.which == 13){
					send_msg();
				}
				
			}
			
		});
		$(document).on('keydown',function(e){
			if(document.getElementById('chatbox').style.display == 'grid') {
				if(e.which == 75){
					alert('k pressed')
				}
			}
		})
		document.getElementById('join_room').addEventListener('input',function(){
			if(!document.getElementById('join_room').value){
				document.getElementById('join').style.display = 'none'
			}
			else {
				document.getElementById('join').style.display = 'block'
			}
		})
		show_chat = ()=>{
			document.getElementById('allmsgs').style.display = 'block'
			document.getElementById('userlist').style.display = 'none'
			document.getElementById('chat_icon').setAttribute('class','bi bi-chat-square-text-fill')
			document.getElementById('people_icon').setAttribute('class','bi bi-people')
		}
		show_people = ()=>{
			document.getElementById('allmsgs').style.display = 'none'
			document.getElementById('userlist').style.display = 'block'
			document.getElementById('people_icon').setAttribute('class','bi bi-people-fill')
			document.getElementById('chat_icon').setAttribute('class','bi bi-chat-square-text')
		}
		var pinned = false
		function pin(user_name){
			if(document.getElementById(`${user_name}div`).className.includes('col-12')){
				document.getElementById('canvas').childNodes.forEach((child)=>{
					child.style.display='flex'
				})
				document.getElementById(`${user_name}div`).className = 'col rounded'
				document.getElementById(user_name).style.width = '';
				pinned = false
			}
			else{
				document.getElementById('canvas').childNodes.forEach((child)=>{
				if(child.id!=`${user_name}div`){
					child.style.display='none'
				}else{
					child.setAttribute('class','col-12 col-sm-12 col-md-12 col-lg-12 rounded')
					document.getElementById(user_name).style.width = `${document.getElementById(user_name).videoWidth}px`
					
				}
				pinned=true

			
			})
			}
		}
		var selfvideo = document.getElementById('selfvideo')

		if (navigator.mediaDevices.getUserMedia) {
		navigator.mediaDevices.getUserMedia({ video: true })
			.then(function (stream) {
			selfvideo.srcObject = stream;
			})
			.catch(function (err0r) {
			console.log("Something went wrong!");
			});
		}
		function toggleFullscreen(elem_id) {
			let elem = document.getElementById(elem_id)
			console.log(elem)
			if (!document.fullscreenElement) {
				elem.requestFullscreen().catch(err => {
				alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
				});
			} else {
				document.exitFullscreen();
			}
		}
		
		toggle_audio_home = ()=>{
			if (audio_on){
				audio_on = false
				document.getElementById('toggle_audio_home').setAttribute('class','btn-danger btn');
			}
			else{
				audio_on = true
				document.getElementById('toggle_audio_home').setAttribute('class','btn-outline-success btn');
			}
		}
		toggle_video_home = ()=>{
			if (video_on){
				video_on = false
				document.getElementById('toggle_video_home').setAttribute('class','btn-danger btn');
				selfvideo.srcObject.getVideoTracks()[0].enabled = !(selfvideo.srcObject.getVideoTracks()[0].enabled);
			}
			else{
				video_on = true
				document.getElementById('toggle_video_home').setAttribute('class','btn-outline-success btn');
				selfvideo.srcObject.getVideoTracks()[0].enabled = !(selfvideo.srcObject.getVideoTracks()[0].enabled);
			}
		}
		$('#myAlert').on('closed.bs.alert', function () {
			document.getElementById('noroom').style.display = 'none'
		})
  </script>

{% endblock content %}